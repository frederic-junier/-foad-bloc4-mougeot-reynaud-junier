<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Véronique Reynaud, Brigitte Mougeot, Frédéric Junier" />
  <title>Projet “Mon avenir”, étape 4</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="--mathjax" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Projet “Mon avenir”, étape 4</h1>
<p class="author">Véronique Reynaud, Brigitte Mougeot, Frédéric Junier</p>
</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table des matières</h2>
<ul>
<li><a href="#développement-web-côté-serveur-en-python">Développement Web côté serveur en Python</a>
<ul>
<li><a href="#exercice-1-découverte-de-flaskflask">Exercice 1 : découverte de <span>Flask</span></a></li>
<li><a href="#exercice-2-formulaire-de-connexion-et-base-de-données">Exercice 2 : formulaire de connexion et base de données</a></li>
<li><a href="#exercice-3-formulaire-de-recherche">Exercice 3 : formulaire de recherche</a></li>
</ul></li>
</ul>
</nav>
<h1 id="développement-web-côté-serveur-en-python">Développement Web côté serveur en Python</h1>
<h2 id="exercice-1-découverte-de-flaskflask">Exercice 1 : découverte de <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a></h2>
<p><a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> est un micro <a href="https://fr.wikipedia.org/wiki/Framework">Framework</a> permettant de développer des applications Web en <a href="https://docs.python.org/3.7/library/cgi.html">Python</a>. Il impose peu de choix prédéfinis au programmeur.</p>
<p>En appui ou en complément, on pourra utiliser les ressources en ligne suivantes :</p>
<ul>
<li>une activité de David Roche autour de <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> construite pour des élèves de première NSI</li>
<li>la documentation officielle de <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> sur <a href="https://flask.palletsprojects.com/en/1.1.x/">https://flask.palletsprojects.com/en/1.1.x/</a></li>
</ul>
<ol type="1">
<li>Récupérer l’archive <code>materiel.zip</code> et l’extraire. L’arboresence du dossier <code>materiel</code> doit être semblable à celle-ci :</li>
</ol>
<p><img src="images/arborescence.png" alt="arborescence" /><br />
</p>
<ol start="2" type="1">
<li>Éditer le fichier <code>main_exo1.py</code> dans un environnement de programmation en <a href="https://docs.python.org/3.7/library/cgi.html">Python</a> tel que <a href="https://thonny.org/">Thonny</a> ou <a href="https://www.spyder-ide.org/">Spyder</a>. Le contenu du fichier est reproduit ci-dessous :</li>
</ol>
<hr />
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> flask <span class="im">import</span> <span class="op">*</span>  <span class="co">#module pour developper une application web</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> sqlite3       <span class="co">#module pour interagir avec une base de donnees sqlite</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> datetime      <span class="co">#module de gestion des dates</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#création d&#39;une instance de l&#39;application</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="at">@app.route</span>(<span class="st">&#39;/&#39;</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">def</span> accueil():</span>
<span id="cb1-11"><a href="#cb1-11"></a>   <span class="co">&quot;Controleur de la  route &#39;/&#39;&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>   date <span class="op">=</span> datetime.datetime.now()</span>
<span id="cb1-13"><a href="#cb1-13"></a>   h <span class="op">=</span> date.hour</span>
<span id="cb1-14"><a href="#cb1-14"></a>   m <span class="op">=</span> date.minute</span>
<span id="cb1-15"><a href="#cb1-15"></a>   s <span class="op">=</span> date.second</span>
<span id="cb1-16"><a href="#cb1-16"></a>   <span class="cf">return</span> <span class="st">&quot;&lt;p&gt;Bonjour il est </span><span class="sc">{}</span><span class="st"> heures </span><span class="sc">{}</span><span class="st"> minutes et </span><span class="sc">{}</span><span class="st"> secondes.&lt;/p&gt;&quot;</span>.<span class="bu">format</span>(h, m, s)</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co"># on ouvre un serveur en local sur le port 8000</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>app.run(host<span class="op">=</span><span class="st">&#39;127.0.0.1&#39;</span>, port<span class="op">=</span><span class="dv">8000</span>)</span></code></pre></div>
<hr />
<ol start="3" type="1">
<li><p>Éxécuter ce script <a href="https://docs.python.org/3.7/library/cgi.html">Python</a>. Dans la console, on devrait obtenir un affichage d’une dizaine de lignes :</p>
<pre><code>* Serving Flask app &quot;main_exo1&quot; (lazy loading)
* Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
* Debug mode: on
* Running on http://127.0.0.1:8000/ (Press CTRL+C to quit)
* Restarting with stat
* Debugger is active!
* Debugger PIN: 266-323-620</code></pre>
<ul>
<li><strong>Question a)</strong> L’application <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a>, portant le nom du script, a lancé un serveur Web dont l’adresse [IP][IP] est ……… (boucle locale) et le port <a href="https://developer.mozilla.org/fr/docs/Glossaire/TCP">TCP</a> est ………..</li>
<li><strong>Question a)</strong> Quel est le protocole de la couche application qui est utilisé lors d’un échange entre un client et un serveur Web ? Où sont situés le serveur et le client si on veut tester l’application ?</li>
<li><strong>Question c)</strong> D’après le code de l’application, si on ouvre un navigateur Web comme Firefox et si on saisit l’<a href="https://developer.mozilla.org/fr/docs/Glossaire/URL">URL</a> <code>http://127.0.0.1:8000/</code> dans la barre d’adresse, quel affichage devrait-on obtenir ?</li>
<li><strong>Question d)</strong> Attendre quelques instants et rafraîchir la page. Que remarque-t-on ? Comment peut-on qualifier ce type de page Web ?</li>
</ul></li>
<li><p>La fonction <code>accueil</code> est préfixée par l’instruction <code>@app.route('/')</code>, qui est un <em>décorateur</em>. Si l’<a href="https://developer.mozilla.org/fr/docs/Glossaire/URL">URL</a> se termine par <code>/</code>, la fonction <code>accueil</code> est appelée et retourne un code <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a> après l’avoir formaté avec des paramètres de temps en heures, minutes et secondes. On parle de <strong>contrôleur de route</strong> ( <code>view</code> dans la terminologie de <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a>). Néanmoins, il serait préférable de retourner une page Web complète en respectant la structure d’un document en <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a>. <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> propose une fonction <code>render_template</code> qui permet de retourner une page <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a> complète. Le terme <em>template</em> signifie que la page peut être paramétrée, comme nous le verrons plus tard. Attenion, tous les fichiers <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a>, doivent se trouver dans le sous-répertoire <code>templates</code> du répertoire <code>matériel</code>.</p>
<ul>
<li><strong>Question a)</strong> Dans la console, arrêter le serveur avec la séquence clavier <code>CTRL + C</code>. Revenir sur la page <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a> et rafraîchir/</li>
<li><strong>Question b)</strong> Dans le code de la fonction <code>accueil</code>, remplacer <code>"accueil1.html"</code> par <code>"acc.html"</code>, enregister sans relancer le serveur. Rafraîhir la page, que se passe-t-il ? Fermer puis relancer le serveur. Quel message d’erreur s’affiche ? Dans la barre d’outils de développement du navigateur (F12), récupérer le code d’erreur <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTTP">HTTP</a>. Quelle différence avec la célèbre erreur 404 ? Rectifier le nom du <em>template</em> puis rafraîchir la page sans arrêter le serveur. La modification est-elle prise en compte ?</li>
<li><strong>Question c)</strong> Arrêter le serveur et activer le mode débogagge avec le paramètre d’éxécution <code>debug = True</code> dans la ligne <code>app.run(debug=True, host='127.0.0.1', port=8000)</code>. Relancer le serveur et rafraîchir la page. Reprendre la question b). Quel message d’erreur obtient-on désormais ? Rectifier le nom du <em>template</em>. Est-il désormais nécessaire de relancer le serveur pour que les modifications soient prises en compte ?</li>
</ul>
<p><strong>Remarque :</strong> En phase de développement, nous activerons toujours le mode débogagge.</p></li>
<li><p>Consulter avec un éditeur de textes, comme <a href="https://notepad-plus-plus.org/">Notepad++</a>, le code du fichier <code>accueil1.html</code>.</p></li>
</ol>
<hr />
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>   <span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;fr&quot;</span><span class="kw">&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>   <span class="kw">&lt;head&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>   <span class="kw">&lt;title&gt;</span>Connexion <span class="kw">&lt;/title&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>   <span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>   <span class="kw">&lt;/head&gt;</span>      </span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>      <span class="kw">&lt;p&gt;</span>Bonjour il est {{heure}} heures {{minute}} minutes et {{seconde}} secondes.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>   <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<hr />
<ul>
<li><strong>Question a)</strong> Compléter <code>render_template("accueil1.html", heure = h, minute = m, seconde = s)</code> est un appel de fonction avec deux types de ………… :
<ul>
<li><em>positionnel</em> : …………….</li>
<li><em>nommés</em> : ………………. Ainsi, <code>render_template</code> affiche une page web en utilisant les valeurs des variables données en paramètre.</li>
</ul></li>
</ul>
<ol start="6" type="1">
<li>Consulter avec un éditeur de textes, comme <a href="https://notepad-plus-plus.org/">Notepad++</a>, le code du fichier <code>accueil1.html</code>.
<ul>
<li><strong>Question a)</strong> Obtient-on le même affichage qu’avec l’application, si on ouvre <code>accueil1.html</code> directement avec un navigateur Web ?</li>
<li><strong>Question b)</strong> Quelle syntaxe particulière permet d’insérer les valeurs de ces paramètres dans le fichier <code>accueil1.html</code> ? Ce mécanisme est effectué par un moteur de template nommé <a href="https://jinja.palletsprojects.com/en/2.11.x/">Jinja</a>, qui permet aussi d’insérer des structures de contrôle comme des tests ou des boucles pour paramétrer plus finement l’affichage du <em>template</em>.</li>
</ul></li>
</ol>
<h2 id="exercice-2-formulaire-de-connexion-et-base-de-données">Exercice 2 : formulaire de connexion et base de données</h2>
<p>L’objectif est de réaliser un formulaire de connexion dans la page d’accueil avec identifiant (<code>login</code>) et mot de passe (<code>password</code>). Le programme de traitement du formulaire doit vérifier l’existence du couple (<code>login</code>, <code>password</code>) dans la base de données <code>monavenir.db</code> fournie dans le dossier <code>materiel</code>.</p>
<p><strong>Cahier des charges :</strong></p>
<ul>
<li>Le formulaire en <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a> dans un fichier <code>accueil2.html</code> placé dans le dossier <code>templates</code>, aura trois champs :
<ul>
<li>un champ de sélection de profil : élève, lycée, admin, établissement du supérieur</li>
<li>un champ de saisie de <code>login</code></li>
<li>un champ de saisie de <code>password</code></li>
</ul></li>
<li>Le formulaire aura un bouton cliquable qui envoie les données au serveur. L’<a href="https://developer.mozilla.org/fr/docs/Glossaire/URL">URL</a> de la requête se termine par <code>'/connexion'</code>, ce qui déclenche l’appel de la fonction <strong>contrôleur de route</strong> <code>connexion</code>.</li>
<li>Cette fonction devra interroger la base de données et selon le succès de la requête et le profil retourner une page web d’erreur ou une page <code>eleve.html</code>, <code>lycee.html</code>, <code>superieur.html</code>, <code>admin.html</code>.</li>
</ul>
<p><img src="images/connexion.png" alt="connexion" /><br />
</p>
<ol type="1">
<li>Ouvrir le fichier <code>accueil2.html</code> qui se trouve dans le répertoire <code>templates</code>. Il contient le code ci-dessous :</li>
</ol>
<hr />
<div class="sourceCode" id="cb4"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb4-1"><a href="#cb4-1"></a>   <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;fr&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="kw">&lt;title&gt;</span>Connexion <span class="kw">&lt;/title&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>    </span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a>   </span>
<span id="cb4-14"><a href="#cb4-14"></a>   <span class="kw">&lt;h1&gt;</span> Mon avenir : formulaire de connexion <span class="kw">&lt;/h1&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>   </span>
<span id="cb4-16"><a href="#cb4-16"></a>   <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/connexion&quot;</span><span class="ot"> method=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a>      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;profil&quot;</span><span class="kw">&gt;</span>Profil : <span class="kw">&lt;/label&gt;</span> </span>
<span id="cb4-19"><a href="#cb4-19"></a>      <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;profil&quot;</span><span class="ot"> name=</span><span class="st">&quot;profil&quot;</span><span class="kw">&gt;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>            <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;admin&quot;</span><span class="kw">&gt;</span>admin<span class="kw">&lt;/option&gt;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>            <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;superieur&quot;</span><span class="kw">&gt;</span>établissement du supérieur<span class="kw">&lt;/option&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>            <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;lycee&quot;</span><span class="kw">&gt;</span>lycée<span class="kw">&lt;/option&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>            <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;eleve&quot;</span><span class="kw">&gt;</span>élève<span class="kw">&lt;/option&gt;</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>      <span class="kw">&lt;/select&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>      <span class="kw">&lt;br&gt;</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;login&quot;</span><span class="kw">&gt;</span>Identifiant : <span class="kw">&lt;/label&gt;</span> </span>
<span id="cb4-27"><a href="#cb4-27"></a>      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> id=</span><span class="st">&quot;login&quot;</span><span class="ot"> name=</span><span class="st">&quot;login&quot;</span><span class="ot"> required</span> <span class="kw">/&gt;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>      <span class="kw">&lt;br&gt;</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>      <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;password&quot;</span><span class="kw">&gt;</span>Mot de passe : <span class="kw">&lt;/label&gt;</span> </span>
<span id="cb4-30"><a href="#cb4-30"></a>      <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;password&quot;</span><span class="ot"> id=</span><span class="st">&quot;password&quot;</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span><span class="ot"> required</span> <span class="kw">/&gt;</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>      <span class="kw">&lt;br&gt;</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>      <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="kw">&gt;</span>Envoyer<span class="kw">&lt;/button&gt;</span>      </span>
<span id="cb4-33"><a href="#cb4-33"></a>   <span class="kw">&lt;/form&gt;</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>   </span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="kw">&lt;/html&gt;</span> </span></code></pre></div>
<hr />
<ul>
<li><strong>Question a)</strong> Quelle est la méthode d’envoi de ce formulaire ? Quelle autre méthode aurait pu être choisie ? Quelles sont les différences entre les deux ?</li>
<li><strong>Question b)</strong> Quelle est l’<a href="https://developer.mozilla.org/fr/docs/Glossaire/URL">URL</a> complète d’envoi du formulaire ?</li>
<li><strong>Question c)</strong> Quel est l’intérêt du type <code>password</code> ?</li>
<li><strong>Question d)</strong> Les attributs <code>id</code>, <code>name</code> et <code>for</code> des éléments du formulaire ont toujours le même nom. Est-ce nécessaire ? A quoi servent ces attributs ?</li>
<li><strong>Question e)</strong> Quels sont les différents types de widgets de formulaires utilisés dans ce formulaire ?</li>
</ul>
<ol start="2" type="1">
<li><p>Reprendre le programme <code>main1.py</code> et l’enregistrer sous un nouveau nom : <code>main2.py</code> dans le même répertoire. Puis modifier la fonction accueil pour qu’elle retourne <code>accueil2.html</code> avec le formulaire.</p></li>
<li><p>Compléter et ajouter la fonction <code>connexion</code> ci-dessous pour traiter les données du formulaire dans le fichier. .</p></li>
</ol>
<hr />
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">from</span> flask <span class="im">import</span> <span class="op">*</span>  <span class="co">#module pour developper une application web</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="im">import</span> sqlite3       <span class="co">#module pour interagir avec une base de donnees sqlite</span></span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#création d&#39;une instance de l&#39;application</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="at">@app.route</span>(<span class="st">&#39;/&#39;</span>)</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="kw">def</span> accueil():</span>
<span id="cb5-10"><a href="#cb5-10"></a>   <span class="co">&quot;Controleur de la  route &#39;/&#39;&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>   <span class="cf">return</span> render_template(<span class="st">&quot;accueil2.html&quot;</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#dispatcheur de route / URL</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="at">@app.route</span>(<span class="st">&#39;/connexion&#39;</span>,methods <span class="op">=</span> [<span class="st">&#39;POST&#39;</span>])</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="kw">def</span> connexion():</span>
<span id="cb5-16"><a href="#cb5-16"></a>   <span class="co">&quot;Controleur de la route &#39;/connexion&#39; &quot;</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>   <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&#39;POST&#39;</span>:</span>
<span id="cb5-18"><a href="#cb5-18"></a>      <span class="co">#les valeurs des paramètres sont dans le dictionnaire request.form </span></span>
<span id="cb5-19"><a href="#cb5-19"></a>      result <span class="op">=</span> request.form</span>
<span id="cb5-20"><a href="#cb5-20"></a>      <span class="co">#récupération de la valeur du paramètre profil</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>      profil <span class="op">=</span> <span class="st">&quot;à compléter&quot;</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>      <span class="co">#récupération de la valeur du paramètre login</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>      login <span class="op">=</span> <span class="st">&quot;à compléter&quot;</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>      <span class="co">#récupération de la valeur du paramètre password</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>      password <span class="op">=</span> <span class="st">&quot;à compléter&quot;</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>      <span class="co">#connexion à la base de données</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>      conn <span class="op">=</span> <span class="st">&quot;à compléter&quot;</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>      <span class="co">#pour récupérer les lignes sous forme de dictionnaire     </span></span>
<span id="cb5-29"><a href="#cb5-29"></a>      conn.row_factory <span class="op">=</span>  sqlite3.Row</span>
<span id="cb5-30"><a href="#cb5-30"></a>      <span class="co">#création d&#39;un curseur pour parcourir la base</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>      cur <span class="op">=</span> <span class="st">&quot;à compléter&quot;</span></span>
<span id="cb5-32"><a href="#cb5-32"></a>      <span class="co">#soumission d&#39;une requête SQL avec paramètres pour (à compléter :  .......)</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>      cur.execute(<span class="st">&quot;SELECT * FROM </span><span class="sc">{profil}</span><span class="st"> WHERE login=? and password=? ;&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb5-34"><a href="#cb5-34"></a>         profil),(login, password))</span>
<span id="cb5-35"><a href="#cb5-35"></a>      <span class="co">#récupération de la ligne de résultat</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>      user <span class="op">=</span> cur.fetchone()</span>
<span id="cb5-37"><a href="#cb5-37"></a>      <span class="co">#fermeture du curseur</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>      <span class="co">&quot;à compléter&quot;</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>      <span class="co">#fermeture de la connexion</span></span>
<span id="cb5-40"><a href="#cb5-40"></a>      <span class="co">&quot;à compléter&quot;</span></span>
<span id="cb5-41"><a href="#cb5-41"></a>      <span class="cf">if</span> user:</span>
<span id="cb5-42"><a href="#cb5-42"></a>            <span class="cf">return</span> render_template(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">.html&quot;</span>.<span class="bu">format</span>(profil))</span>
<span id="cb5-43"><a href="#cb5-43"></a></span>
<span id="cb5-44"><a href="#cb5-44"></a></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="co"># on ouvre un serveur en local sur le port 8000</span></span>
<span id="cb5-46"><a href="#cb5-46"></a>app.run(debug <span class="op">=</span> <span class="va">True</span>, host<span class="op">=</span><span class="st">&#39;127.0.0.1&#39;</span>, port<span class="op">=</span><span class="dv">8000</span>)</span></code></pre></div>
<hr />
<ul>
<li><strong>Remarque :</strong> L’accès à la base de données s’effectue en trois temps :
<ul>
<li><p>connexion et création d’un curseur qui est l’objet permettant de lire ou d’écrire dans la base</p></li>
<li><p>interrogation ou modification de la base avec une requête en <a href="https://www.w3schools.com/sql/">SQL</a> formatée à l’aide de paramètres :</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>cur.execute(<span class="st">&quot;SELECT * FROM </span><span class="sc">{profil}</span><span class="st"> WHERE login=? and password=? ;&quot;</span>.<span class="bu">format</span>(</span>
<span id="cb6-2"><a href="#cb6-2"></a>   profil),(login, password))</span></code></pre></div>
<p>le nom de la table est inséré dans la requête avec un formatage de chaîne de caractères en Python, l’insertion de valeurs dans la condition du <code>WHERE</code> suit une syntaxe particulière : les <code>?</code> seront remplacés dans l’ordre par les valeurs du <code>tuple</code> de paramètres (login, password). Il s’agit d’un mécanisme de sécurité conte l’injection de code <a href="https://www.w3schools.com/sql/">SQL</a> malveillant à la place des valeurs attendues. Voir le site <a href="https://bobby-tables.com/">https://bobby-tables.com/</a>.</p></li>
<li><p>fermeture du curseur puis de la base</p></li>
</ul></li>
<li><strong>Question a)</strong> Tester une connexion élève dont le couple (<code>login</code>,<code>password</code> ) = (<code>eleve</code>,<code>test</code>). Quelle est la page <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTML">HTML</a> retournée par le <code>connexion</code> ? Où sont stockées les données du formulaire dans le code Python ci-dessus ? Faire apparaître ces données avec les outils de développement du navigateur Web.</li>
</ul>
<p><img src="images/formulaire.png" alt="formulaire" /><br />
</p>
<ul>
<li><strong>Question b)</strong> Créer dans le dossier <code>templates</code>, des fichiers <code>admin.html</code>, <code>lycee.html</code> et <code>superieur.html</code> qui seront retournés par la fonction <code>connexion</code> pour les autres profils possibles. Tester que tout fonctionne avec des utilisateurs sélectionnés directement dans la base avec <a href="sqlitebrowser">sqlitebrowser</a>.</li>
</ul>
<h2 id="exercice-3-formulaire-de-recherche">Exercice 3 : formulaire de recherche</h2>
<p>Une fois la connexion réalisée, on souhaite qu’un utilisateur de profil élève puisse interroger la base : par exemple rechercher les établissements du supérieur par type (il y en a 10 ) et par commune.</p>
<p><img src="images/recherche.png" alt="recherche" /><br />
</p>
<ol type="1">
<li><p>Ajouter au programme <code>main2.py</code> le contenu du fichier <code>cadeau.py</code>.</p></li>
<li><p>La fonction <code>rechercheFormation</code> retourne un formulaire de recherche de formation selon deux critères pour la route <code>"/rechercheFormation"</code>, consulter son code ci-dessous.</p></li>
</ol>
<hr />
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">#dispatcheur de route / URL</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="at">@app.route</span>(<span class="st">&#39;/rechercheFormation&#39;</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">def</span> rechercheFormation():</span>
<span id="cb7-4"><a href="#cb7-4"></a>   <span class="co">&quot;Controleur de la route &#39;/rechercheFormation&#39; &quot;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>   conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;monavenir.db&#39;</span>)     </span>
<span id="cb7-6"><a href="#cb7-6"></a>   conn.row_factory <span class="op">=</span>  sqlite3.Row  <span class="co">#pour récupérer les lignes sous forme de dictionnaire     </span></span>
<span id="cb7-7"><a href="#cb7-7"></a>   cur <span class="op">=</span> conn.cursor()</span>
<span id="cb7-8"><a href="#cb7-8"></a>   cur.execute(<span class="st">&quot;SELECT DISTINCT type FROM superieur ;&quot;</span>)</span>
<span id="cb7-9"><a href="#cb7-9"></a>   list_type <span class="op">=</span> cur.fetchall()</span>
<span id="cb7-10"><a href="#cb7-10"></a>   cur.execute(<span class="st">&quot;SELECT DISTINCT commune FROM superieur ;&quot;</span>)</span>
<span id="cb7-11"><a href="#cb7-11"></a>   list_commune <span class="op">=</span> cur.fetchall()</span>
<span id="cb7-12"><a href="#cb7-12"></a>   conn.close()</span>
<span id="cb7-13"><a href="#cb7-13"></a>   <span class="cf">return</span> render_template(<span class="st">&quot;rechercheFormation.html&quot;</span>, </span>
<span id="cb7-14"><a href="#cb7-14"></a>                           list_type <span class="op">=</span> list_type,  list_commune <span class="op">=</span> list_commune)</span></code></pre></div>
<hr />
<ul>
<li><strong>Question a)</strong> Pourquoi n’a-t-on pas écrit <code>@app.route('/rechercheFormation ',methods = ['POST'])</code> ?<br />
</li>
<li><strong>Question b)</strong> Traduire en français les deux requêtes <a href="https://www.w3schools.com/sql/">SQL</a> exécutées par la fonction.</li>
<li><strong>Question c)</strong> Ouvrir le fichier <code>rechercheFormation.html</code> dans le dossier <code>templates</code> dont le code est donné ci-dessous. Tester le formulaire avec l’élève test. Comment sont générées les listes d’option par le moteur de template <a href="https://jinja.palletsprojects.com/en/2.11.x/">Jinja</a> ?</li>
</ul>
<hr />
<div class="sourceCode" id="cb8"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">&lt;html</span><span class="ot"> lang=</span><span class="st">&quot;fr&quot;</span><span class="kw">&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">&lt;title&gt;</span>Recherche de formation<span class="kw">&lt;/title&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">&lt;meta</span><span class="ot"> charset=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span>    </span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a></span>
<span id="cb8-13"><a href="#cb8-13"></a>   </span>
<span id="cb8-14"><a href="#cb8-14"></a>   <span class="kw">&lt;h1&gt;</span> <span class="kw">&lt;em&gt;</span>Mon avenir<span class="kw">&lt;/em&gt;</span> interface de recherche <span class="kw">&lt;/h1&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>   </span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a>   </span>
<span id="cb8-18"><a href="#cb8-18"></a>   <span class="kw">&lt;h2&gt;</span>Formulaire de recherche d&#39;établissement du supérieur <span class="kw">&lt;/h2&gt;</span></span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a>   <span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/resultatRecherche&quot;</span><span class="ot"> method=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>   </span>
<span id="cb8-22"><a href="#cb8-22"></a>   <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;type&quot;</span><span class="kw">&gt;</span>Type : <span class="kw">&lt;/label&gt;</span> </span>
<span id="cb8-23"><a href="#cb8-23"></a>   <span class="kw">&lt;br&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>   <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;type&quot;</span><span class="ot"> name=</span><span class="st">&quot;type&quot;</span><span class="kw">&gt;</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>      <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;indifferent&quot;</span><span class="kw">&gt;</span>indifférent<span class="kw">&lt;/option&gt;</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>      {% for type in list_type %}</span>
<span id="cb8-27"><a href="#cb8-27"></a>      <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;{{type[0]}}&quot;</span><span class="kw">&gt;</span>{{type[0]}}<span class="kw">&lt;/option&gt;</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>      {% endfor %}</span>
<span id="cb8-29"><a href="#cb8-29"></a>   <span class="kw">&lt;/select&gt;</span></span>
<span id="cb8-30"><a href="#cb8-30"></a></span>
<span id="cb8-31"><a href="#cb8-31"></a>   <span class="kw">&lt;br&gt;</span></span>
<span id="cb8-32"><a href="#cb8-32"></a></span>
<span id="cb8-33"><a href="#cb8-33"></a></span>
<span id="cb8-34"><a href="#cb8-34"></a>   <span class="kw">&lt;label</span><span class="ot"> for=</span><span class="st">&quot;commune&quot;</span><span class="kw">&gt;</span>Commune : <span class="kw">&lt;/label&gt;</span> </span>
<span id="cb8-35"><a href="#cb8-35"></a>   <span class="kw">&lt;br&gt;</span></span>
<span id="cb8-36"><a href="#cb8-36"></a>   <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;commune&quot;</span><span class="ot"> name=</span><span class="st">&quot;commune&quot;</span><span class="kw">&gt;</span></span>
<span id="cb8-37"><a href="#cb8-37"></a>      <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;indifferent&quot;</span><span class="kw">&gt;</span>indifférent<span class="kw">&lt;/option&gt;</span></span>
<span id="cb8-38"><a href="#cb8-38"></a>      {% for commune in list_commune %}</span>
<span id="cb8-39"><a href="#cb8-39"></a>      <span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;{{commune[0]}}&quot;</span><span class="kw">&gt;</span>{{commune[0]}}<span class="kw">&lt;/option&gt;</span></span>
<span id="cb8-40"><a href="#cb8-40"></a>      {% endfor %}</span>
<span id="cb8-41"><a href="#cb8-41"></a>   <span class="kw">&lt;/select&gt;</span></span>
<span id="cb8-42"><a href="#cb8-42"></a></span>
<span id="cb8-43"><a href="#cb8-43"></a>   <span class="kw">&lt;br&gt;</span></span>
<span id="cb8-44"><a href="#cb8-44"></a></span>
<span id="cb8-45"><a href="#cb8-45"></a>   <span class="kw">&lt;button</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="kw">&gt;</span>Envoyer<span class="kw">&lt;/button&gt;</span>      </span>
<span id="cb8-46"><a href="#cb8-46"></a></span>
<span id="cb8-47"><a href="#cb8-47"></a>   <span class="kw">&lt;/form&gt;</span></span>
<span id="cb8-48"><a href="#cb8-48"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a>   <span class="kw">&lt;footer&gt;</span></span>
<span id="cb8-50"><a href="#cb8-50"></a>      <span class="kw">&lt;ul&gt;</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>         <span class="kw">&lt;li&gt;</span> <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/interface&quot;</span><span class="kw">&gt;</span>Retour à l&#39;interface du profil<span class="kw">&lt;/a&gt;&lt;/li&gt;</span></span>
<span id="cb8-52"><a href="#cb8-52"></a>         <span class="kw">&lt;li&gt;&lt;a</span><span class="ot"> href=</span><span class="st">&quot;/&quot;</span><span class="kw">&gt;</span>Déconnexion<span class="kw">&lt;/a&gt;&lt;/li&gt;</span></span>
<span id="cb8-53"><a href="#cb8-53"></a>      <span class="kw">&lt;/ul&gt;</span>   </span>
<span id="cb8-54"><a href="#cb8-54"></a>   <span class="kw">&lt;/footer&gt;</span></span>
<span id="cb8-55"><a href="#cb8-55"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb8-56"><a href="#cb8-56"></a><span class="kw">&lt;/html&gt;</span> </span></code></pre></div>
<hr />
<ol type="1">
<li>Compléter la fonction <code>resultatRecherche</code> qui doit traiter les données du formulaire envoyé depuis <code>rechercheFormation.html</code>. Certains blocs commentés en <code>#TO DO</code>, doivent être complétés avec l’exécution par le curseur des requêtes <a href="https://www.w3schools.com/sql/">SQL</a> appropriées.</li>
</ol>
<hr />
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">#dispatcheur de route / URL</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="at">@app.route</span>(<span class="st">&#39;/resultatRecherche&#39;</span>, methods <span class="op">=</span> [<span class="st">&#39;POST&#39;</span>])</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">def</span> resultatRecherche():</span>
<span id="cb9-4"><a href="#cb9-4"></a>   <span class="co">&quot;Controleur de la route &#39;/resultatFRecherche&#39; &quot;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>   <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&#39;POST&#39;</span>:</span>
<span id="cb9-6"><a href="#cb9-6"></a>      result <span class="op">=</span> request.form</span>
<span id="cb9-7"><a href="#cb9-7"></a>      conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;monavenir.db&#39;</span>)     </span>
<span id="cb9-8"><a href="#cb9-8"></a>      conn.row_factory <span class="op">=</span>  sqlite3.Row  <span class="co">#pour récupérer les lignes sous forme de dictionnaire     </span></span>
<span id="cb9-9"><a href="#cb9-9"></a>      cur <span class="op">=</span> conn.cursor()</span>
<span id="cb9-10"><a href="#cb9-10"></a>      <span class="cf">if</span> result[<span class="st">&#39;type&#39;</span>] <span class="op">==</span> <span class="st">&#39;indifferent&#39;</span>:</span>
<span id="cb9-11"><a href="#cb9-11"></a>            <span class="cf">if</span> result[<span class="st">&#39;commune&#39;</span>] <span class="op">!=</span> <span class="st">&#39;indifferent&#39;</span>:</span>
<span id="cb9-12"><a href="#cb9-12"></a>               cur.execute(<span class="st">&#39;SELECT nom, idSuperieur, type, commune FROM superieur  WHERE commune = ?    ORDER BY type;&#39;</span>, (result[<span class="st">&#39;commune&#39;</span>],))</span>
<span id="cb9-13"><a href="#cb9-13"></a>            <span class="cf">else</span>:</span>
<span id="cb9-14"><a href="#cb9-14"></a>               <span class="co">&quot;à compléter&quot;</span> <span class="co">#TO DO        </span></span>
<span id="cb9-15"><a href="#cb9-15"></a>      <span class="cf">elif</span> result[<span class="st">&#39;commune&#39;</span>] <span class="op">==</span> <span class="st">&#39;indifferent&#39;</span>:</span>
<span id="cb9-16"><a href="#cb9-16"></a>            <span class="co">&quot;à compléter&quot;</span>  <span class="co">#TO DO </span></span>
<span id="cb9-17"><a href="#cb9-17"></a>      <span class="cf">else</span>:</span>
<span id="cb9-18"><a href="#cb9-18"></a>         <span class="co">&quot;à compléter&quot;</span>  <span class="co">#TO DO </span></span>
<span id="cb9-19"><a href="#cb9-19"></a>      liste_sup <span class="op">=</span> cur.fetchall()</span>
<span id="cb9-20"><a href="#cb9-20"></a>      conn.close()</span>
<span id="cb9-21"><a href="#cb9-21"></a>      <span class="cf">return</span> render_template(<span class="st">&quot;resultatRecherche.html&quot;</span>, </span>
<span id="cb9-22"><a href="#cb9-22"></a>                              liste_sup <span class="op">=</span> liste_sup,  result <span class="op">=</span> result)</span></code></pre></div>
<hr />
<ol start="4" type="1">
<li><p>En s’inspirant de <code>rechercheFormation.html</code>, compléter les <code>TO DO / à compléter</code> dans le <em>template</em> <code>resultatRecherche.html</code> dans le dossier <code>templates</code> qui pourra être rempli avec les valeurs des variables <code>liste_sup</code> et <code>result</code> calculées par la fonction <code>resultatRecherche</code>.</p></li>
<li><p>On veut désormais créer une fonction <strong>contrôleur de route</strong> <code>interface</code> qui redirige vers la page d’accueil du profil <code>eleve.html</code>, <code>lycee.html</code> etc … depuis n’importe quelle page du site.</p></li>
</ol>
<blockquote>
<p><strong>Remarque :</strong> Il faut donc utiliser un mécanisme de mémorisation du profil lors de la navigation dans le site. A l’origine, le protocole <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTTP">HTTP</a> imaginé par Tim Berners-Lee était « sans état » : chaque requête était indépendante, sans possibilité pour le serveur de lier deux requêtes successives venant du même système et donc de garder en mémoire des informations sur un utilisateur. En 1994, pour favoriser le développement du commerce en ligne, des ingénieurs de <a href="https://fr.wikipedia.org/wiki/Netscape_Navigator">Netscape</a> proposent un mécanisme d’échange d’information au format texte, un <strong>cookie</strong> stocké chez le client ou le serveur. L’article <a href="https://linc.cnil.fr/fr/une-petite-histoire-du-cookie">https://linc.cnil.fr/fr/une-petite-histoire-du-cookie</a> raconte l’histoire des <strong>cookies</strong>. Dans notre cas, nous allons utiliser un <strong>cookie de session</strong> stocké sur le serveur, la <strong>session</strong> étant l’interaction client/serveur entre la connexion et la déconnexion. Lors de la déconnexion, il faut penser à effacer le <strong>cookie de session</strong>.</p>
</blockquote>
<p>Répondre aux questions et compléter le fichier <code>main2.py</code> au fur et à mesure.</p>
<ul>
<li><strong>Question a)</strong> Après la définition de l’application, il faut définir une clef secrète de session pour chiffrer le <strong>cookie de session</strong>, normalement il faut utiliser une clef aléatoire. Quelle est la cle choisie dans le code ci-dessous ?</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">#création d&#39;une instance de l&#39;application</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#clef de session</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>app.secret_key <span class="op">=</span> <span class="st">&quot;clef secrète&quot;</span></span></code></pre></div>
<ul>
<li><strong>Question b)</strong> Dans la fonction <code>connexion</code>, enrichir le bloc final de <code>if user</code> avec le peuplement du <strong>cookie de session</strong> qui dans <a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> est un objet avec la même interface qu’un dictionnaire. On peut remarquer qu’il n’est plus forcément nécessaire de transmettre au <em>template</em> le dictionnaire <code>user</code> : il faut penser à remplacer <code>user</code> par <code>session['user']</code> dans le <em>template</em> <code>eleve.html</code> :</li>
</ul>
<hr />
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="cf">if</span> user:</span>
<span id="cb11-2"><a href="#cb11-2"></a>   <span class="co">#dictionnaire de session</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>   session[<span class="st">&#39;user&#39;</span>] <span class="op">=</span> <span class="bu">dict</span>(user)  <span class="co">#les objets de type ROW retournés ne sont pas sérialisables et stockables dans le dictionnaire du cookie de session  </span></span>
<span id="cb11-4"><a href="#cb11-4"></a>   session[<span class="st">&#39;profil&#39;</span>] <span class="op">=</span> profil    <span class="co">#on stocke le profil dans le cookie de session</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>   <span class="cf">return</span> render_template(<span class="st">&quot;</span><span class="sc">{}</span><span class="st">.html&quot;</span>.<span class="bu">format</span>(profil))</span></code></pre></div>
<hr />
<ul>
<li><strong>Question c)</strong> Ajouter la fonction <strong>contrôleur de route</strong> <code>interface</code> en complétant le code proposé :</li>
</ul>
<hr />
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#dispatcheur de route / URL</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="at">@app.route</span>(<span class="st">&#39;/interface&#39;</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">def</span> interface():</span>
<span id="cb12-4"><a href="#cb12-4"></a>   <span class="co">&quot;Controleur de la route &#39;/interface&#39; &quot;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>   <span class="cf">if</span> <span class="st">&#39;profil&#39;</span> <span class="kw">in</span> session <span class="kw">and</span> session[<span class="st">&#39;profil&#39;</span>]:</span>
<span id="cb12-6"><a href="#cb12-6"></a>      <span class="co">&quot;à compléter avec un return render_template(...)&quot;</span> <span class="co">#TO DO</span></span></code></pre></div>
<hr />
<ul>
<li><strong>Question d)</strong> Enfin, compléter avec la fonction <strong>contrôleur de route</strong> <code>deconnexion</code> :</li>
</ul>
<hr />
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">#dispatcheur de route / URL</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="at">@app.route</span>(<span class="st">&#39;/deconnexion&#39;</span>)</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">def</span> deconnexion():</span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="co">#on vide le dictionnaire de session</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="bu">print</span>(session)     <span class="co">#debug</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    session.clear()    <span class="co">#on vide le dictionnaire de session</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="bu">print</span>(session)     <span class="co">#debug</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="co">#redirection vers la route controlée par la fonction accueil</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="co">#return render_template(&#39;/&#39;)</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="cf">return</span> redirect(url_for(<span class="st">&#39;accueil&#39;</span>)) </span></code></pre></div>
<hr />
<ol start="6" type="1">
<li>Explorons les cookies de session ave les outils de développement.
<ul>
<li><strong>Question a)</strong> Ouvrir un navigateur et la fenêtre des outils de développement.</li>
<li><strong>Question b)</strong> Réaliser une session complète avec l’élève test : connexion, recherche de formation, retour à l’interface du profil, déconnexion.</li>
<li><strong>Question c)</strong> Afficher lors de chaque chargement de page, les <strong>cookies</strong> contenus dans les requêtes et réponses <a href="https://developer.mozilla.org/fr/docs/Glossaire/HTTP">HTTP</a> : pour quelles pages a-t-on un <strong>cookie</strong> dans la requête et dans la réponse ? juste dans la requête ? Observer l’évolution de la valeur du <strong>cookie</strong> de requête.</li>
<li><strong>Question d)</strong> Interpréter les valeurs affichés par les deux instructions <code>print</code> lors de l’exécution de la fonction.</li>
</ul></li>
</ol>
<p><img src="images/cookies.png" alt="cookies" /><br />
</p>
</body>
</html>
